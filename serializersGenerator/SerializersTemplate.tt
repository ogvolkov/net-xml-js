<#@ template language="C#" #>
<#@ import namespace="System.Linq" #>

var netXmlSerializer = (function(){
// initialize cross-browser xml parser
    var parseXml = function() {
        if (typeof window.DOMParser != "undefined") {
            return function(xmlStr) {
                return ( new window.DOMParser() ).parseFromString(xmlStr, "text/xml");
            };
        } else if (typeof window.ActiveXObject != "undefined" &&  new window.ActiveXObject("Microsoft.XMLDOM")) {
            return function(xmlStr) {
                var xmlDoc = new window.ActiveXObject("Microsoft.XMLDOM");
                xmlDoc.async = "false";
                xmlDoc.loadXML(xmlStr);
                return xmlDoc;
            };
        } else {
            throw new Error("No XML parser found");
        }
    }();
	<# 
		var types = _typesInfo.Types;
			
		foreach (var type in types)
		{#>
	function deserializeNode<#=type.Name#>(node) {				
				var result = {};
			<# 
			var propertyVisitor = new DeserializePropertyGenerator();

			foreach (var property in type.GetProperties())
			{
				var propertyType = property.PropertyType;
				if (propertyType == typeof(DateTime))
				{
					WriteLine(propertyVisitor.VisitDate(property.Name));					
				}
                else if (propertyType == typeof(int))
                {		
					WriteLine(propertyVisitor.VisitInteger(property.Name));
				}
				else if (types.Contains(propertyType))
                {
					WriteLine(propertyVisitor.VisitReference(property.Name, propertyType.Name));
				}
                else
                {
					var collectionType = TypesInfo.TryGetCollectionType(propertyType);					

					if (collectionType != null)
                    {
						var itemType = collectionType.GetGenericArguments().First();
						WriteLine(propertyVisitor.VisitCollection(property.Name, itemType.Name));
				    }
					else
					{
						WriteLine(propertyVisitor.VisitString(property.Name));
                    }				
				}
			}#>
			return result;
		}

	<#
	}			
	#>
    return {
		<#
			foreach (var type in types)
		{#>
			deserialize<#=type.Name#>: function(xml) {
						var xmlDoc = parseXml(xml);					
						return deserializeNode<#=type.Name#>(xmlDoc);
					},
		<#
		}			
		#>
	}
})();